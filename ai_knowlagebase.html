<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ AIæ¤œç´¢</title>
    <link rel="stylesheet" href="ai_knowlagebase.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ” ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ AIæ¤œç´¢</h1>
        <p class="subtitle">Google Driveå†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’æ¤œç´¢ã—ã¾ã™</p>

        <div class="search-box">
            <textarea 
                id="queryInput" 
                placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„&#10;ä¾‹: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²ã‚æ–¹ã«ã¤ã„ã¦æ•™ãˆã¦"
            ></textarea>
        </div>

        <button class="search-btn" id="searchBtn" onclick="search()">
            <span id="btnText">æ¤œç´¢ã™ã‚‹</span>
        </button>

        <div class="result-box" id="resultBox">
            <div id="loadingState" class="loading">
                <div class="spinner"></div>
                <div>æ¤œç´¢ä¸­...</div>
            </div>

            <div id="resultContent">
                <div class="result-title">ğŸ’¡ å›ç­”</div>
                <div class="result-content" id="answerText"></div>

                <div class="metadata" id="metadata"></div>

                <div class="sources" id="sourcesBox">
                    <div class="sources-title">ğŸ“š å‚ç…§å…ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</div>
                    <div id="sourcesList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // âš ï¸ ã“ã“ã«n8nã®Webhook URLã‚’è¨­å®šã—ã¦ãã ã•ã„
        const API_ENDPOINT = 'http://localhost:5678/webhook/ai-search';

        async function search() {
            const query = document.getElementById('queryInput').value.trim();
            
            if (!query) {
                alert('è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const resultBox = document.getElementById('resultBox');
            const loadingState = document.getElementById('loadingState');
            const resultContent = document.getElementById('resultContent');
            const searchBtn = document.getElementById('searchBtn');
            const btnText = document.getElementById('btnText');

            // UIçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            resultBox.classList.add('show');
            resultBox.classList.remove('error');
            loadingState.style.display = 'block';
            resultContent.style.display = 'none';
            searchBtn.disabled = true;
            btnText.textContent = 'æ¤œç´¢ä¸­...';

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }

                const data = await response.json();

                // çµæœè¡¨ç¤º
                document.getElementById('answerText').textContent = data.answer;
                
                // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
                const metadata = document.getElementById('metadata');
                metadata.innerHTML = `
                    <div class="metadata-item">ğŸ“„ ${data.metadata.fileCount}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§</div>
                    <div class="metadata-item">ğŸ• ${new Date(data.metadata.timestamp).toLocaleString('ja-JP')}</div>
                `;

                // ã‚½ãƒ¼ã‚¹è¡¨ç¤º
                if (data.sources && data.sources.length > 0) {
                    const sourcesBox = document.getElementById('sourcesBox');
                    const sourcesList = document.getElementById('sourcesList');
                    
                    sourcesList.innerHTML = data.sources.map(source => `
                        <div class="source-item">
                            <svg class="source-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <a href="${source.url}" target="_blank" class="source-link">${source.name}</a>
                        </div>
                    `).join('');
                    
                    sourcesBox.style.display = 'block';
                }

                loadingState.style.display = 'none';
                resultContent.style.display = 'block';

            } catch (error) {
                console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                
                resultBox.classList.add('error');
                document.getElementById('answerText').textContent = 
                    'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚\n\n' + 
                    'ã‚¨ãƒ©ãƒ¼è©³ç´°: ' + error.message;
                
                loadingState.style.display = 'none';
                resultContent.style.display = 'block';
                document.getElementById('sourcesBox').style.display = 'none';
            } finally {
                searchBtn.disabled = false;
                btnText.textContent = 'æ¤œç´¢ã™ã‚‹';
            }
        }

        // Enterã‚­ãƒ¼ã§æ¤œç´¢ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰
        document.getElementById('queryInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                search();
            }
        });
    </script>
</body>
</html>